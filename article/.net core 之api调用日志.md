### env: ###

.net core 3.1

### å‰è¨€ ###

åå°ç®¡ç†ç³»ç»Ÿéœ€è¦å¯¹ç®¡ç†å‘˜æ“ä½œè¿›è¡Œè®°å½•ï¼Œå°†è®°å½•æ˜ å°„ä¸ºæ“ä½œæ—¥å¿—

target: å­˜å…¥mongodb

**å“ªäº›æ“ä½œéœ€è¦è¢«è®°å½•ï¼Ÿ**

- å¢ : æ–°å¢åçš„æ•°æ®éƒ½ä¼šè¢«è®°å½•ï¼Œæ— é¡»å†è®°å½•ä¸€æ¬¡
- åˆ  : æ•æ„Ÿæ•°æ®éœ€è¦ï¼Œä¸ä»‹æ„æ—¥å¿—è¿‡å¤šå¯ä»¥éƒ½è®°å½•
- æ”¹ : åŒä¸Š
- æŸ¥ : ä¸éœ€è¦
- å¼‚å¸¸ä¿¡æ¯ : ä¸éœ€è¦

æ‰€ä»¥å…³æ³¨çš„ç±»å‹æ€»ä½“æ¥çœ‹åˆ†ä¸ºä¸¤ç§ï¼šå¼‚å¸¸/éå¼‚å¸¸

**ä¸ºä»€ä¹ˆåˆ å’Œæ”¹ä¸ç”¨åŒºåˆ†ï¼Ÿ**

é¦–å…ˆå¼‚å¸¸è‚¯å®šæ˜¯è¦æœ‰æ˜æ˜¾åŒºåˆ†çš„ï¼Œå› ä¸ºå¼‚å¸¸æ˜¯æœ€éœ€è¦è¢«å…³æ³¨,å†åè¿‡æ¥æƒ³æƒ³å¦‚æœåŒºåˆ†ï¼Œé‚£ä¹ˆå¼‚å¸¸å’Œåˆ /æ”¹è¯¥å¦‚ä½•åŒºåˆ†ï¼Ÿï¼Œç­”æ¡ˆæ˜¯æ²¡æœ‰ï¼Œå› ä¸ºå¼‚å¸¸å¯èƒ½ä¼šæ˜¯

**å¦‚ä½•åŒºåˆ†å¢åˆ æ”¹æŸ¥ï¼Ÿ**

å¯¹äºä½¿ç”¨è¿‡**restful**çš„åº”è¯¥éå¸¸å®¹æ˜“çš„å°±æƒ³åˆ° **Put**/**DELETE**/**Patch**,è¿™ä¸æ­£å¥½å¯ä»¥ç”¨æ¥åŒºåˆ†å— ğŸ˜

#### ä¸€ã€æ—¥å¿—ç»“æ„ ####

æ ¹æ®æ‰€éœ€è‡ªå®šä¹‰å³å¯ï¼Œå‚è€ƒç»“æ„:

	/// <summary>
    /// æ˜¯å¦å¼‚å¸¸
    /// </summary>
    public bool IsError { get; set; }
    /// <summary>
    /// è®¿é—®è€…ç½‘ç»œåœ°å€ä¿¡æ¯
    /// </summary>
    public string Client { get; set; }
    /// <summary>
    /// æœåŠ¡å™¨ç½‘ç»œåœ°å€ä¿¡æ¯ [å¦‚æœé¡¹ç›®æœ‰é›†ç¾¤ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­æ˜¯å“ªå°æœåŠ¡å™¨]
    /// </summary>
    public string Server { get; set; }
    /// <summary>
    /// è¯·æ±‚åœ°å€
    /// </summary>
    public string Url { get; set; }
    /// <summary>
    /// è¯·æ±‚æ–¹å¼
    /// </summary>
    public string Method { get; set; }
    /// <summary>
    /// é”™è¯¯ä¿¡æ¯
    /// </summary>
    public string Error { get; set; }
    /// <summary>
    /// è¯·æ±‚å‚æ•°
    /// </summary>
    public string Body { get; set; }
    /// <summary>
    /// å“åº”ç»“æœ
    /// </summary>
    public string Res { get; set; }
    /// <summary>
    /// æ“ä½œäºº
    /// </summary>
    public string Operator { get; set; }
    /// <summary>
    /// è¯´æ˜
    /// </summary>
    public string Remark { get; set; }
    /// <summary>
    /// è¯·æ±‚æ—¶é—´
    /// </summary>
    public DateTime RequestTime { get; set; }
    /// <summary>
    /// å“åº”æ—¶é—´
    /// </summary>
    public DateTime ResponseTime { get; set; }

#### äºŒã€æ—¥å¿—çš„æ–°å¢ä¸æŸ¥è¯¢ ####

interfaceå®šä¹‰ï¼š

	public interface IManagerLogService<T>
    {
        Task WriteAsync(T log);

        Task<T[]> ReadArrayAsync(PageModelPara page, Expression<Func<T, bool>> predicate);
    }

å®ç°ï¼šç•¥...

#### ä¸‰ã€actionè°ƒç”¨æ‹¦æˆª ####

ç”±äº.net core è‡ªèº«æ”¯æŒæ‹¦æˆªå™¨çš„åŠŸèƒ½ï¼Œåªè¦å®ç°å’Œç»™æ§åˆ¶å™¨æ ‡è®°å³å¯

ä¸ºæ–¹ä¾¿åæœŸæ‰©å±•ç»´æŠ¤ï¼Œæ‹¦æˆªå™¨å¯å•ç‹¬å‡ºæ¥:

	public class {name}Attribute : Attribute, // æ–¹ä¾¿æ§åˆ¶å™¨æ ‡è®°
		IActionFilter, // å®ç°actionæ‹¦æˆª
		ILogFilter // è‡ªå®šä¹‰æ¥å£/æ ‡è®°

	{

		public void OnActionExecuted(ActionExecutedContext context)
        {
		}

		public void OnActionExecuting(ActionExecutingContext context)
        {
		}
	}

å…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ä¸º**IActionFilter**çš„å®ç°æ–¹æ³•ï¼Œ

**OnActionExecuting** - å½“actionæ‰§è¡Œæ—¶è§¦å‘ï¼Œåœ¨æ­¤å¤„ä½ å¯ä»¥:

- è‡ªå®šä¹‰å‚æ•°å¤„ç†ï¼Œä¾‹å¦‚åšå‚æ•°éªŒè¯
- è·å–è¯·æ±‚æ—¶é—´å‚è€ƒå€¼ï¼Œ**HttpRequest**ä¸­å¹¶æ²¡æœ‰é»˜è®¤æä¾›è¯·æ±‚æ—¶é—´ï¼Œæ•…æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªå‚è€ƒè¯·æ±‚æ—¶é—´æ–¹ä¾¿è®°å½•
- è®°å½•Bodyå‚æ•°,
	- å½“actionæ‰§è¡Œå®Œæ¯•åï¼Œ**HttpRequest.Body**é»˜è®¤æ˜¯ä¼šæ¸…ç©ºçš„[å…·ä½“ç¼˜ç”±å¾…æ ¸å¯¹]ï¼Œæ•…æ‰§è¡Œå®Œåæ— æ³•è·å–
	- action åªå…³æ³¨è‡ªå®šä¹‰çš„ç»“æ„ï¼Œå¹¶ä¸ä¼šå®Œæ•´çš„è§£æbody[ä¾‹å¦‚å‰ç«¯ä¼ å…¥åç«¯æœªå®šä¹‰çš„åˆ—å®é™…ä¸Šæ˜¯ä¸å½±å“æ“ä½œçš„],æ•…æˆ‘ä»¬å¯ä»¥ä»ä¼ å…¥å‚æ•°ä¸­è·å–body[æ³¨ï¼šåœ¨æ‰§è¡Œæ—¶ï¼Œactionå‚æ•°æ˜¯å·²ç»ä¼ å…¥äº†çš„]
	- é¿å…äºŒæ¬¡è¯»å– Body æµ

**OnActionExecuted** - å½“actionæ‰§è¡Œå®Œæ¯•åè§¦å‘

ä»æ—¥å¿—æ‹¦æˆªæ¥çœ‹ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬è¦ï¼š

- è·å–è¯·æ±‚ç»“æŸæ—¶é—´å‚è€ƒå€¼
- åšè¿‡æ»¤

	a.å› ä¸ºåªå…³æ³¨Putå’ŒDelete,å¯ä»¥å…ˆåšä¸€ä¸ª**Method**è¿‡æ»¤

		if (!(HttpMethods.Put.Equals(context.HttpContext.Request.Method)
            || HttpMethods.Delete.Equals(context.HttpContext.Request.Method))) // ä»…å…³æ³¨ putã€delete
        {
            return;
        }

	b.æ“ä½œæˆåŠŸæ‰åº”è¯¥è¢«è®°å½•ï¼Œä¾‹å¦‚ï¼šä¿®æ”¹çš„æ—¶å€™ï¼Œå¡«çš„ä¿¡æ¯æœªé€šè¿‡éªŒè¯

	æ‰€ä»¥è¿˜åº”è¯¥é€šè¿‡è¿”å›ç»“æœæ¥è¿‡æ»¤

	å¸¸è§çš„ç»“æœæœ‰ä¸¤ç§ï¼š

	1. é€šè¿‡Responseçš„çŠ¶æ€ç æ¥å‘ŠçŸ¥è¯·æ±‚æ˜¯å¦è¯·æ±‚æ­£å¸¸
	2. è‡ªå®šä¹‰ç»“æ„ï¼Œé€šè¿‡æ­¤ç»“æ„ä¸­çš„æŸä¸ªåˆ—æ¥åˆ¤æ–­æ˜¯å¦è¯·æ±‚æ­£å¸¸ï¼Œç„¶åæ‰€æœ‰apiç»Ÿä¸€è¿”å›æ­¤ç»“æ„

	ä¸ªäººæ›´åå‘äºç¬¬äºŒç§ï¼Œèƒ½å¤Ÿæ›´åŠ çµæ´»ï¼Œä¹Ÿä¸å®¹æ˜“ä¸HTTPçŠ¶æ€ç æ··æ·†ï¼Œé‚£ä¹ˆå°±ä»¥ç¬¬äºŒç§ä¸ºä¾‹ï¼Œå®šä¹‰ç»“æ„ä½“:

	public interface IInfo // æ­¤å¤„å®šä¹‰ä¸ºæ¥å£æ˜¯ä¸ºäº†æ–¹ä¾¿è¿‡æ»¤
    {
        object GetData();
        bool IsSuccess();
    }

	ok,æ—¢ç„¶è¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ç»“æ„ä¿¡æ¯ï¼Œé‚£ä¹ˆ**ActionExecutedContext.Result** å°±åº”è¯¥æ˜¯ä¸ª **ObjectResult**

	é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆé€šè¿‡**Result**æ‹¿åˆ°**ObjectResult**ï¼Œç„¶åå†é€šè¿‡**ObjectResult.Value**æ‹¿åˆ°æˆ‘ä»¬çš„è¿”å›å€¼ã€‚

	å†é€šè¿‡è¿”å›å€¼çš„**IsSuccess**æ¥è¿›è¡Œè¿‡æ»¤

ok,è¿‡æ»¤å®Œæ¯•åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”Ÿæˆæ—¥å¿—ä¿¡æ¯äº†.

	HttpRequest request = context.HttpContext.Request;
    ConnectionInfo connection = context.HttpContext.Connection;

	// è·å–è¯·æ±‚åœ°å€
	$"{request.Scheme}://{request.Host}{request.Path} {request.QueryString}"

	// è·å–è®¿é—®è€…çš„ip ç«¯å£
	$"{connection.RemoteIpAddress}:{connection.RemotePort}"

	// è·å–æœåŠ¡å™¨çš„ip ç«¯å£
	$"{connection.LocalIpAddress}:{connection.LocalPort}"

	// è·å–æ“ä½œäºº
	// ä¾‹å¦‚é€šè¿‡ context.HttpContext.User è·å–

#### å››ã€è¯»å–é¡¹ç›®ä¸­çš„æ–‡æ¡£æ³¨é‡Š ####

è·å–å¤‡æ³¨æ¯”è¾ƒç‰¹æ®Šï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ€§ç„¶åé€šè¿‡actionçš„**MethodInfo**æ¥é€šè¿‡åå°„è·å–ï¼Œä½†æ˜¯è¿™ç§æ¯”è¾ƒéº»çƒ¦è€Œä¸”å®¹æ˜“å¿˜è®°å†™ï¼Œæ‰€ä»¥é€‰æ‹©äº†è¯»å–æ–‡æ¡£æ³¨é‡Š

é¦–å…ˆï¼Œè¯»å–çš„å‰ææ˜¯éœ€è¦é¡¹ç›®ç”Ÿæˆæ–‡æ¡£æ³¨é‡Š:

	é¡¹ç›®->Properties->Build->XML documentation file->ç”Ÿæˆåœ°å€

*æ³¨ï¼šè®°å¾—é€‰å¥½Configurationå’ŒPlatform*

ç”Ÿæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥åŠ è½½xmlè¿›è¡Œè¯»å–äº†ï¼š

	var xpath = new XPathDocument(Path.Combine(AppContext.BaseDirectory, {xml_path}))

XPathçš„è¯»å–æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªactionè¯»å–ç¤ºä¾‹:

	var summary = xpath.SelectSingleNode($"doc/members/member[@name='M:{actionå…¨è·¯å¾„}']/summary").Value;

å…·ä½“ä¼ å€¼å‚è€ƒé¡¹ç›®çš„ç”Ÿæˆçš„xml

#### å››ã€ç‰¹æ€§æ³¨å…¥ ####

åœ¨æˆ‘ä»¬å®šä¹‰çš„æ‹¦æˆªå™¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å†™å…¥æ—¥å¿—ï¼Œæ—¢ç„¶è¦å†™å…¥æ—¥å¿—ï¼Œé‚£å°±è¦æœ‰**IManagerLogService**çš„å®ç°ç±»

æœ€ä¸ºç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯åœ¨æ‹¦æˆªå™¨ä¸­ç›´æ¥ 

	IManagerLogService service = new XxxImpl();

è¿™ç§æ–¹å¼åŠ å¤§äº†è€¦åˆæ€§ï¼Œè€Œä¸”ä¹Ÿä¸æ–¹ä¾¿æ‰©å±•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼è®©æ‹¦æˆªå™¨èƒ½å¤Ÿé€šè¿‡æ³¨å…¥çš„æ–¹å¼æ¥åˆ›å»ºï¼Ÿ

ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬èƒ½æƒ³åˆ°çš„ï¼Œå¾®è½¯åº”è¯¥ä¹Ÿèƒ½æƒ³åˆ°ï¼Œç­”æ¡ˆæ˜¯**Microsoft.AspNetCore.Mvc.ServiceFilterAttribute**

åœ¨æ­¤ç±»ä¸­æœ‰ä¸€ä¸ª**Type ServiceType**å±æ€§ï¼Œé€šè¿‡æ­¤å±æ€§æŒ‡å®šåˆ°æ‹¦æˆªå™¨å™¨å³å¯é€šè¿‡æ³¨å…¥çš„æ–¹å¼åˆ›å»ºæ‹¦æˆªå™¨

æ‰€ä»¥å†åˆ›å»ºä¸€ä¸ªæ ‡è®°ç‰¹æ€§ï¼š

	public class LogFlagAttribute : ServiceFilterAttribute
    {
        public LogFlagAttribute() : base(typeof({æ‹¦æˆªå™¨.name}Attribute))
        {
        }
    }

ç„¶ååœ¨æ§åˆ¶å™¨ä¸ŠåŠ [LogFlag]å³å¯

#### äº”ã€å…¨å±€æ³¨å…¥æ‹¦æˆªå™¨ ####

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé€šè¿‡åœ¨æ§åˆ¶å™¨ä¸ŠåŠ ç‰¹æ€§è¿›è¡Œï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥è¿›è¡Œè§£è€¦,æˆ‘ä»¬çš„æ‹¦æˆªå™¨ä¼¼ä¹å·²ç»éå¸¸å¼ºå¤§äº†

ä½†å†æƒ³ä¸€æƒ³ï¼Œä¼¼ä¹æ¯ä¸ªæ§åˆ¶å™¨éƒ½èƒ½å¤ŸåŠ ä¸Šæ—¥å¿—è®°å½•çš„æ ‡è®°ï¼Œä¸ºäº†é«˜å¤ç”¨ä½è€¦åˆ[æå‡é€¼æ ¼...],æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹å¼èƒ½å¤Ÿå…¨å±€çš„å»æ³¨å†Œæ‹¦æˆªå™¨å‘¢ï¼Ÿ

[ğŸ˜é€šè¿‡ä¸‡èƒ½çš„åº¦å¨˜/google/å®˜æ–¹æ–‡æ¡£å¾—çŸ¥ï¼š]ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œåœ¨æˆ‘ä»¬servicesæ³¨å†Œé‡Œé¢ï¼Œæœ‰ï¼š

	public static IMvcBuilder AddControllers(this IServiceCollection services, Action<MvcOptions> configure);

åœ¨MvcOptionsä¸­ï¼Œæœ‰ï¼š

	//
    // Summary:
    //     Gets a list of Microsoft.AspNetCore.Mvc.ApplicationModels.IApplicationModelConvention
    //     instances that will be applied to the Microsoft.AspNetCore.Mvc.ApplicationModels.ApplicationModel
    //     when discovering actions.
    public IList<IApplicationModelConvention> Conventions { get; }

é€šè¿‡æ·»åŠ æ­¤å±æ€§å¯ä»¥ç»™**ApplicationModel**æ¥è¿›è¡Œç»‘å®š

ç¤ºä¾‹ï¼š

	public interface ILogFilter : IFilterMetadata
    {
    }

	public class ApplicationLogConvention<T> : IApplicationModelConvention where T : IFilterMetadata
    {

        private readonly Lazy<IFilterFactory> _factory = new Lazy<IFilterFactory>(() => new LogFilterFactory<T>());

        public void Apply(ApplicationModel application)
        {
            foreach (var controller in application.Controllers)
            {
                if (!controller.Filters.Any(x => x is T))
                {
                    controller.Filters.Add(_factory.Value);// æ·»åŠ æ‹¦æˆªå™¨
                }
            }
        }

        protected virtual bool ShouldApply(ActionModel action) => true;

    }

	public class LogFilterFactory<T> : IFilterFactory where T: IFilterMetadata
    {
        public bool IsReusable => true;

        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
             return serviceProvider.GetRequiredService<T>();
        }
    }

æ­¤å¤„ä½¿ç”¨**IFilterFactory**çš„åŸå› ä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿æ³¨å…¥ã€‚

ç„¶ååœ¨**ConfigureServices**è¿›è¡Œæ³¨å…¥å³å¯

å‚è€ƒï¼š [ModelStateInvalidFilter](https://source.dot.net/#Microsoft.AspNetCore.Mvc.Core/Infrastructure/ModelStateInvalidFilter.cs,4b0eb6b2fda4ea2f) - .net core é»˜è®¤çš„actionæ‹¦æˆªï¼Œç”¨äºè¿›è¡Œå±æ€§éªŒè¯

**å¦‚ä½•æ³¨å…¥MvcOptionsï¼Ÿ**

å¦‚æœä¸æƒ³ç›´æ¥åœ¨**AddControllers**ä¸­é€šè¿‡**new**çš„æ–¹å¼æ·»åŠ **IApplicationModelConvention**ï¼Œå¯é€šè¿‡ï¼š

	//
    // Summary:
    //     Registers a type that will have all of its I[Post]ConfigureOptions registered.
    //
    // Parameters:
    //   services:
    //     The Microsoft.Extensions.DependencyInjection.IServiceCollection to add the services
    //     to.
    //
    // Type parameters:
    //   TConfigureOptions:
    //     The type that will configure options.
    //
    // Returns:
    //     The Microsoft.Extensions.DependencyInjection.IServiceCollection so that additional
    //     calls can be chained.
    public static IServiceCollection ConfigureOptions<TConfigureOptions>(this IServiceCollection services) where TConfigureOptions : class;

ç„¶åå®ç°**IConfigureOptions<MvcOptions>**å†æ³¨å†Œå³å¯ã€‚

#### å…­ã€å¼‚å¸¸æ‹¦æˆª ####

ä½¿ç”¨.net core apiçš„åº”è¯¥éƒ½çŸ¥é“ï¼Œapiçš„è®¿é—®åœ¨ä»¥ä¸€ç§ç®¡é“å¼çš„é£æ ¼åœ¨å¤„ç†é€šè¿‡ï¼Œé€šè¿‡**Func<RequestDelegate,RequestDelegate>**è¿›è¡Œä¼ é€’ï¼Œ

ç›¸å…³æ–¹æ³•ï¼š
	public static IApplicationBuilder UseMiddleware<TMiddleware>(this IApplicationBuilder app, params object[] args);

ç¤ºä¾‹ï¼šç•¥

å‚è€ƒï¼š**Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware** - å¼€å‘æ—¶çš„é»˜è®¤å¼‚å¸¸ä¸­é—´ä»¶


